// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ========================================
 * ARQUITETURA MULTI-LOJA
 * ========================================
 */

// Loja/Franquia: Armazena dados únicos de cada unidade.
model Store {
  id        String   @id @default(cuid())
  name      String   @unique // Ex: "Forfit - Cascavel"
  subdomain String   @unique // Ex: "cascavel" -> cascavel.forfitalimentos.com.br
  city      String
  state     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Chaves de API e configurações específicas da loja
  abacatepayApiKey        String?
  abacatepayWebhookSecret String?

  // Relacionamentos
  inventory StoreInventory[]
  orders    Order[]
  admins    User[]
}

// Tabela de ligação para controlar o estoque de cada produto em cada loja.
model StoreInventory {
  id        String   @id @default(cuid())
  quantity  Int      @default(0) // Quantidade em estoque
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([storeId, productId]) // Garante que só há uma entrada de estoque por produto/loja
}


/**
 * ===========================
 * Enums
 * ===========================
 */

// Papel do usuário no sistema
enum UserRole {
  CUSTOMER
  ADMIN // Admin de uma loja específica
  SUPER_ADMIN // Gerencia todas as lojas e o catálogo global
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum CouponType {
  PERCENT
  FIXED
}

enum PointsReason {
  EARN_ORDER
  REDEEM_ORDER
  ADJUSTMENT
  INFLUENCER_BONUS
}

enum InfluencerPointsReason {
  INFLUENCER_BONUS
  ADJUSTMENT
}

/**
 * ===========================
 * Core: Users & Auth
 * ===========================
 */

model User {
  id                String    @id @default(cuid())
  name              String
  birthDate         DateTime?
  cpf               String    @unique
  email             String    @unique
  passwordHash      String
  phone             String?
  abacateCustomerId String?
  emailVerifiedAt   DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Papel do usuário (NOVO)
  role UserRole @default(CUSTOMER)

  // Se o usuário for ADMIN, ele está ligado a uma loja (NOVO)
  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id], onDelete: SetNull)

  // relations
  addresses              Address[]
  favorites              Favorite[]
  orders                 Order[]
  couponRedemptions      CouponRedemption[]
  refreshTokens          RefreshToken[]
  emailTokens            EmailVerificationToken[]
  passwordTokens         PasswordResetToken[]
  pointsAccount          UserPointsAccount?
  userPointsTransactions UserPointsTransaction[]

  @@index([email])
  @@index([cpf])
  @@index([storeId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  ip        String?
  userAgent String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

/**
 * ===========================
 * Address Book
 * ===========================
 */

model Address {
  id        String   @id @default(cuid())
  userId    String
  street    String
  number    String
  district  String
  city      String
  state     String
  zip       String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/**
 * ===========================
 * Catálogo Global
 * ===========================
 */

model Ingredient {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())

  products ProductIngredient[]
}

model Derivative {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())

  products ProductDerivative[]
}

model Product {
  id             String   @id @default(cuid())
  name           String
  code           String   @unique
  description    String?
  photoUrl       String?
  costPriceCents Int
  salePriceCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacionamentos
  inventory      StoreInventory[] // MODIFICADO: Relacionamento com estoque por loja
  ingredients    ProductIngredient[]
  derivatives    ProductDerivative[]
  nutrition      NutritionTable?
  favorites      Favorite[]
  orderItems     OrderItem[]
  promotionItems PromotionItem[]

  @@index([name])
}

model ProductIngredient {
  productId    String
  ingredientId String

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Restrict)

  @@id([productId, ingredientId])
}

model ProductDerivative {
  productId    String
  derivativeId String

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  derivative Derivative @relation(fields: [derivativeId], references: [id], onDelete: Restrict)

  @@id([productId, derivativeId])
}

model NutritionTable {
  id           String   @id @default(cuid())
  productId    String   @unique
  servingSize  String?
  energyKcal   Int?
  carbs        Decimal? @db.Decimal(10, 2)
  protein      Decimal? @db.Decimal(10, 2)
  fatTotal     Decimal? @db.Decimal(10, 2)
  fatSaturated Decimal? @db.Decimal(10, 2)
  fatTrans     Decimal? @db.Decimal(10, 2)
  fiber        Decimal? @db.Decimal(10, 2)
  sodium       Decimal? @db.Decimal(10, 2)
  createdAt    DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * Favorites
 * ===========================
 */

model Favorite {
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
}

/**
 * ===========================
 * Orders & Billing
 * ===========================
 */

model Order {
  id               String      @id @default(cuid())
  status           OrderStatus @default(PENDING)
  subtotalCents    Int
  discountCents    Int         @default(0)
  shippingCents    Int         @default(0)
  totalCents       Int
  pointsEarned     Int         @default(0)
  pointsRedeemed   Int         @default(0)
  couponCode       String?
  influencerId     String?
  abacateBillingId String?     @unique
  abacateStatus    String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relacionamentos
  userId                       String
  user                         User @relation(fields: [userId], references: [id])
  storeId                      String // NOVO: Pedido pertence a uma loja
  store                        Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)
  items                        OrderItem[]
  delivery                     Delivery?
  redemptions                  CouponRedemption[]
  userPointsTransactions       UserPointsTransaction[]
  influencerPointsTransactions InfluencerPointsTransaction[]
  influencer                   Influencer? @relation(fields: [influencerId], references: [id])

  @@index([userId])
  @@index([storeId])
  @@index([abacateBillingId])
}

model OrderItem {
  id             String @id @default(cuid())
  orderId        String
  productId      String
  nameSnapshot   String
  codeSnapshot   String
  unitPriceCents Int
  quantity       Int
  totalCents     Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
}

model Delivery {
  id        String   @id @default(cuid())
  orderId   String   @unique
  street    String
  number    String
  district  String
  city      String
  state     String
  zip       String
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * Coupons & Influencers (Globais)
 * ===========================
 */

model Coupon {
  id           String     @id @default(cuid())
  code         String     @unique
  type         CouponType
  value        Int
  active       Boolean    @default(true)
  usedCount    Int        @default(0)
  influencerId String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  redemptions CouponRedemption[]
  influencer  Influencer? @relation(fields: [influencerId], references: [id])

  @@index([influencerId])
}

model CouponRedemption {
  id                  String   @id @default(cuid())
  couponId            String
  orderId             String
  userId              String
  amountDiscountCents Int
  createdAt           DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])
  order  Order  @relation(fields: [orderId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([couponId])
  @@index([orderId])
  @@index([userId])
}

model Influencer {
  id        String   @id @default(cuid())
  name      String
  handle    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coupons       Coupon[]
  orders        Order[]
  pointsAccount InfluencerPointsAccount?
  transactions  InfluencerPointsTransaction[]
}

model InfluencerPointsAccount {
  id           String   @id @default(cuid())
  influencerId String   @unique
  balance      Int      @default(0)
  createdAt    DateTime @default(now())

  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
}

model InfluencerPointsTransaction {
  id           String                 @id @default(cuid())
  influencerId String
  orderId      String?
  points       Int
  reason       InfluencerPointsReason
  createdAt    DateTime               @default(now())

  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id])

  @@index([influencerId])
  @@index([orderId])
}

/**
 * ===========================
 * User Points
 * ===========================
 */

model UserPointsAccount {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPointsTransaction {
  id        String       @id @default(cuid())
  userId    String
  orderId   String?
  points    Int
  reason    PointsReason
  createdAt DateTime     @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id])

  @@index([userId])
  @@index([orderId])
}

/**
 * ===========================
 * Promotions (Globais)
 * ===========================
 */

model Promotion {
  id             String   @id @default(cuid())
  code           String   @unique
  costPriceCents Int
  salePriceCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  items PromotionItem[]
}

model PromotionItem {
  id          String @id @default(cuid())
  promotionId String
  productId   String
  quantity    Int    @default(1)

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([promotionId, productId])
}